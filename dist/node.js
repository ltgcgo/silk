"use strict";import{WebSocket,WebSocketServer as WebSocketService}from"ws";import{fetch,Request,Response}from"undici";import os from"node:os";import fs from"node:fs";import http from"node:http";import crypto from"node:crypto";
if(!globalThis.self){globalThis.self=globalThis};
"use strict";(()=>{var _=class{#e;#o;#i=!1;#n=[];#t={open:[],message:[],error:[],close:[]};addEventListener(e,t){this.#e?e!="open"?this.#e.addEventListener(e,t):t(new Event("open")):this.#t[e].push(t)}get binaryType(){return this.#e?.binaryType||""}get bufferedAmount(){return this.#e?.bufferedAmount||0}get extensions(){return this.#e?.extensions||""}get readyState(){return this.#e?.readyState||0}get url(){return this.#e?.url||this.#o}attach(e){if(this.#i)return!1;if(this.#e)throw new Error("Already attached a WebSocket object");this.#e=e;let t=this;switch(e.readyState){case 0:case 1:{for(let r in this.#t)this.#t[r].forEach(c=>{e.addEventListener(r,c)});let a=new Event("open");this.#t.open.forEach(r=>{r(a)});break}case 2:case 3:{t.dispatchEvent(new Event("close"));break}}}close(...e){return this.#i=!0,this.#e?.close(...e)}send(e){this.#e?this.#e.send(e):this.#n.push(e)}constructor(e){this.#o=e.url.replace("http","ws"),this.addEventListener("open",t=>{for(;this.#n.length>0;)this.#e.send(this.#n.shift())})}},E={args:process.argv.slice(2),os:os.platform(),variant:"Node",version:process.version.replace("v",""),persist:!0,exit:(e=0)=>{process.exit(e)},getEnv:(e,t)=>process.env[e]||t,memUsed:()=>process.memoryUsage(),randomInt:e=>Math.floor(Math.random()*e),readFile:async function(e,t){return new Uint8Array((await fs.promises.readFile(e,t)).buffer)},serve:(e,t={})=>{let a=t.port||8e3,r=t.hostname||"127.0.0.1",c=http.createServer(async function(i,s){let n,f=new ReadableStream({type:"bytes",start:h=>{n=h},cancel:h=>{},autoAllocateChunkSize:65536}),u={method:i.method,headers:i.headers},m=["GET","HEAD"].indexOf(u.method)==-1;i.on("data",h=>{n.enqueue(h)}).on("end",()=>{n.close()}),m&&(u.body=f,u.duplex="half");let l=new Request(`${i.headers["x-forwarded-proto"]||"http"}://${i.headers.host}${i.url}`,u),d=await e(l);d?.headers?.forEach((h,v)=>{s.setHeader(v,h)}),s.statusCode=d?.status||200,d?.statusText&&(s.statusMessage=d.statusText),s.flushHeaders();let o=d.body.getReader(),p=!0;for(;p;)await o.read().then(({done:h,value:v})=>{h?(s.end(),p=!1):s.write(v)})});return c.on("upgrade",async(i,s,n)=>{let f={method:i.method,headers:i.headers},u=new Request(`${i.headers["x-forwarded-proto"]||"http"}://${i.headers.host}${i.url}`,f);u.raw={requester:i,socket:s,head:n},await e(u)}),c.listen(a,r,()=>{(t.onListen||function({port:i,hostname:s}){console.error(`WingBlade serving at http://${s}:${i}`)})({port:a,hostname:r})}),c},setEnv:(e,t)=>{process.env[e]=t},sleep:function(e,t=0){return new Promise((a,r)=>{setTimeout(a,e+Math.floor(t*Math.random()))})},upgradeWebSocket:e=>{let t=new WebSocketService({noServer:!0}),a=new _(e);return t.handleUpgrade(e.raw.requester,e.raw.socket,e.raw.head,function(r){a.attach(r)}),{socket:a,response:new Response(null,{status:200})}},writeFile:async function(e,t,a={}){let r={flag:"w"};a.append&&(r.flag="a"),a.signal&&(r.signal=a.signal),a.mode&&(r.mode=a.mode),await fs.promises.writeFile(e,t,r)}};var T="currentTarget,explicitOriginalTarget,originalTarget,srcElement,target".split(",");var g={account:"user",application:"app",content:"text",created_at:"atNew",edited_at:"atEdit",favourites_count:"sumFav",in_reply_to_account_id:"replyUser",in_reply_to_id:"replyPost",language:"lang",media_attachments:"media",mentions:"ats",reblog:"boost",reblogs_count:"sumBoost",replies_count:"sumReply",sensitive:"cwReal",spoiler_text:"cwText",visibility:"access",followers_count:"sumFan",following_count:"sumSub",display_name:"dispName",avatar_static:"avatarStatic",header_static:"headerStatic",statuses_count:"sumPost",last_status_at:"atLastPost",noindex:"noIndex",verified_at:"atVerify",shortcode:"code",static_url:"static",visible_in_picker:"inPicker",expires_at:"atExpire",votes_count:"sumVote",voters_count:"sumVoter",website:"site",preview_url:"preview",remote_url:"remote",preview_remote_url:"previewRemote",text_url:"text",description:"alt"},k={update:"postNew","status.update":"postEdit",delete:"postDel"},y={maxAge:2592e5,maxCount:100,pageSize:40},S=class extends EventTarget{#e=100;#o=2592e5;#i="";#n;#t=[];#l={};#u=[];#f=[];#p=[];#s=[];#r={};#d=!1;USER_NORMAL=0;USER_NOEXEMPT=1;USER_EXCLUDED=2;filePath="";#c(e,t){return(t.atNew||0)-(e.atNew||0)}#m(){}#v(){}#w(){}#a(e){for(let t in e)g[t]&&(e[g[t]]=e[t],delete e[t]);return e.atNew&&(e.atNew=new Date(e.atNew).getTime()),e.atEdit&&(e.atEdit=new Date(e.atEdit).getTime()),e.atVerify&&(e.atVerify=new Date(e.atVerify).getTime()),e.atExpire&&(e.atExpire=new Date(e.atExpire).getTime()),e.app&&this.#a(e.app),e.user&&this.#a(e.user),e.media?.forEach(t=>{this.#a(t)}),e.emojis?.forEach(t=>{this.#a(t)}),e.ats?.forEach(t=>{this.#a(t)}),e.user&&e.user.fields?.forEach(t=>{this.#a(t)}),e.poll&&(e.poll.options?.forEach(t=>{this.#a(t)}),this.#a(e.poll)),e}#h(e,t){return this.#a(e),e?.user?.username&&(e.handle=`@${e.user.username}@${t.domain}`),e.rid=`${e.id}@${t.domain}`,e}receiver(e,t){let a,r=!0,c=Date.now(),i=c-y.maxAge;switch(t.event){case"update":case"status.update":{let s=t.payload.constructor==String?JSON.parse(t.payload):t.payload;if(this.#h(s,e),s.atNew<i){r=!1;break}if(this.#r[s.rid]){let n=this.#s.indexOf(this.#r[s.rid]);n>-1&&(this.#s[n]=s,this.#r[s.rid]=s,console.debug(`MODIFY Post ${s.rid} success.`))}else this.#s.unshift(s),this.#r[s.rid]=s,console.debug(`CREATE Post ${s.rid} success.`);a=s;break}case"delete":{let s=`${t.payload}@${e.domain}`;if(this.#r[s]){let n=this.#s.indexOf(this.#r[s]);n>-1?(this.#s.splice(n,1),console.debug(`DELETE Post ${s} success (${n}).`)):console.warn(`DELETE Post ${s} not found in postStore.`)}else console.warn(`DELETE Post ${s} not found in postRef.`);a=t.payload;break}default:console.error(`Unknown message type ${t.event} from ${e.domain}.`),console.error(t)}this.#s.sort(this.#c),this.#s.length>this.#e&&this.#s.splice(this.#e,this.#s.length-this.#e).forEach(s=>{delete this.#r[s.rid]}),r&&this.dispatchEvent(new MessageEvent(k[t.event]||t.event,{data:a}))}getPosts(){return this.#s}getServers(){return this.#t}startFor(e){e.ws=new WebSocket(`wss://${e.domain}/api/v1/streaming/`),e.ws.addEventListener("open",()=>{e.auth?(e.ws.send(`{"type":"subscribe","stream":"public:local","access_token":"${e.auth||""}"}}`),console.info(`Authenticated local timeline started for ${e.domain}.`)):(e.ws.send('{"type":"subscribe","stream":"public:local"}'),console.info(`Local timeline started for ${e.domain}.`)),e.hook&&(e.ws.send(`{"type":"subscribe","stream":"user","access_token":"${e.auth||""}"}`),console.info(`User stream started for ${e.domain}.`))}),e.ws.addEventListener("message",t=>{let a=JSON.parse(t.data);this.receiver.call(this,e,a)}),e.ws.addEventListener("close",()=>{AbortSignal.timeout(3e3).onabort=()=>{this.startFor(e)}})}launch(e){this.#d||(this.#t.forEach(async t=>{if(console.info(`Starting for ${t.domain}.`),console.debug(t),this.startFor.call(this,t),!e){let a={headers:{}};t.auth&&(a.headers.Authorization=`Bearer ${t.auth}`);let r=await fetch(`https://${t.domain}/api/v1/timelines/public?local=true&only_media=false&limit=${y.pageSize}`,a);r.status==200?(await r.json())?.forEach(c=>{this.receiver(t,{event:"update",payload:c})}):(console.error(`Post fetching for ${t.domain} failed: ${r.status} ${r.statusText}`),console.error(await r.json()))}}),this.#d=!0)}constructor({servers:e,serversCw:t,instance:a,serversTk:r,streamOnly:c=!1,filePath:i="./auth.json"}){super(),e?.forEach(s=>{let n={domain:s,ws:void 0,cw:!1,hook:s==a,auth:!1};this.#l[s]=this.#t.length,this.#t.push(n)}),t?.forEach(s=>{let n={domain:s,ws:void 0,cw:!0,hook:s==a,auth:!1};this.#l[s]=this.#t.length,this.#t.push(n)}),r?.forEach(s=>{this.#t[this.#l[s[0]]].auth=s[1]}),this.#i=a,this.launch(c)}};var w=new TextEncoder("utf-8"),b=async function(e){let t=`Silk@${WingBlade.variant}`;switch(console.debug(`${t} - Better Together`),e[0]||"serve"){case"login":{console.error("Deprecated."),WingBlade.exit(0);break}case"serve":{console.error("Starting the Silk server!");let a=WingBlade.getEnv("LIST_SERVER")?.split(",")||[],r=WingBlade.getEnv("LIST_SERVER_CW")?.split(",")||[],c=WingBlade.getEnv("LIST_SERVER_TK")?.split(",")||[],i=WingBlade.getEnv("HOOK_SERVER"),s=WingBlade.getEnv("NO_BATCH_REQUEST","0")=="1";i||console.error("Hook server not defined!"),c.forEach((l,d,o)=>{let p=l.indexOf("=");p>-1&&(o[d]=[l.slice(0,p),l.slice(p+1)])});let n={servers:a,serversCw:r,serversTk:c,instance:i,streamOnly:s};console.info(n);let f=new S(n),u=w.encode("[]"),m=[];f.addEventListener("postNew",async({data:l})=>{let d=`{"event":"set","data":${JSON.stringify(l)}}`;m.forEach(async o=>{o.send(d)}),u=w.encode(JSON.stringify(f.getPosts()))}),f.addEventListener("postEdit",async({data:l})=>{let d=`{"event":"set","data":${JSON.stringify(l)}}`;m.forEach(async o=>{o.send(d)}),u=w.encode(JSON.stringify(f.getPosts()))}),f.addEventListener("postDel",async({data:l})=>{let d=`{"event":"delete","data":${JSON.stringify(l)}}`;m.forEach(async o=>{o.send(d)}),u=w.encode(JSON.stringify(f.getPosts()))}),WingBlade.serve(l=>{let d=new URL(l.url);switch(l.method?.toLowerCase()){case"get":{switch(d.pathname){case"/nr/silk/servers":{let o=[];return f.getServers().forEach(({domain:p,cw:h,ws:v})=>{o.push({domain:p,cw:h,active:v.readyState==1})}),new Response(JSON.stringify(o),{status:200,headers:{"content-type":"application/json",server:t}});break}case"/nr/silk/timeline":case"/nr/silk/timeline/":return new Response(u,{status:200,headers:{"content-type":"application/json",server:t}});case"/rt/silk/timeline":case"/rt/silk/timeline/":{if(l.headers.get("upgrade")=="websocket"){let{socket:o,response:p}=WingBlade.upgradeWebSocket(l);return o.addEventListener("open",()=>{o.send('{"event":"ack"}'),m.push(o)}),o.addEventListener("close",()=>{let h=m.indexOf(o);h>-1&&m.splice(h,1)}),p}else return new Response("SSE isn't supported yet.",{status:400,server:t});break}default:return new Response(`Endpoint ${d.pathname} not found.`,{status:404,server:t})}break}default:return new Response("Method disallowed.",{status:405,server:t})}});break}default:console.error(`Unknown subcommand "${e.join(" ")}"`)}};self.WingBlade=E;b(E.args);})();
