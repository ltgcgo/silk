"use strict";import{WebSocket,WebSocketServer as WebSocketService}from"ws";import{fetch,Request,Response}from"undici";import os from"node:os";import fs from"node:fs";import http from"node:http";import crypto from"node:crypto";
if(!globalThis.self){globalThis.self=globalThis};
"use strict";(()=>{var y=class{#e;#r;#a=!1;#s=[];#t={open:[],message:[],error:[],close:[]};addEventListener(e,t){this.#e?e!="open"?this.#e.addEventListener(e,t):t(new Event("open")):this.#t[e].push(t)}get binaryType(){return this.#e?.binaryType||""}get bufferedAmount(){return this.#e?.bufferedAmount||0}get extensions(){return this.#e?.extensions||""}get readyState(){return this.#e?.readyState||0}get url(){return this.#e?.url||this.#r}attach(e){if(this.#a)return!1;if(this.#e)throw new Error("Already attached a WebSocket object");this.#e=e;let t=this;switch(e.readyState){case 0:case 1:{for(let r in this.#t)this.#t[r].forEach(l=>{e.addEventListener(r,l)});let s=new Event("open");this.#t.open.forEach(r=>{r(s)});break}case 2:case 3:{t.dispatchEvent(new Event("close"));break}}}close(...e){return this.#a=!0,this.#e?.close(...e)}send(e){this.#e?this.#e.send(e):this.#s.push(e)}constructor(e){this.#r=e.url.replace("http","ws"),this.addEventListener("open",t=>{for(;this.#s.length>0;)this.#e.send(this.#s.shift())})}},f={args:process.argv.slice(2),os:os.platform(),variant:"Node",version:process.version.replace("v",""),persist:!0,exit:(e=0)=>{process.exit(e)},getEnv:(e,t)=>process.env[e]||t,memUsed:()=>process.memoryUsage(),randomInt:e=>Math.floor(Math.random()*e),readFile:async function(e,t){return new Uint8Array((await fs.promises.readFile(e,t)).buffer)},serve:(e,t={})=>{let s=t.port||8e3,r=t.hostname||"127.0.0.1",l=http.createServer(async function(a,n){let h,u=new ReadableStream({type:"bytes",start:o=>{h=o},cancel:o=>{},autoAllocateChunkSize:65536}),i={method:a.method,headers:a.headers},w=["GET","HEAD"].indexOf(i.method)==-1;a.on("data",o=>{h.enqueue(o)}).on("end",()=>{h.close()}),w&&(i.body=u,i.duplex="half");let g=new Request(`${a.headers["x-forwarded-proto"]||"http"}://${a.headers.host}${a.url}`,i),d=await e(g);d?.headers?.forEach((o,c)=>{n.setHeader(c,o)}),n.statusCode=d?.status||200,d?.statusText&&(n.statusMessage=d.statusText),n.flushHeaders();let v=d.body.getReader(),p=!0;for(;p;)await v.read().then(({done:o,value:c})=>{o?(n.end(),p=!1):n.write(c)})});return l.on("upgrade",async(a,n,h)=>{let u={method:a.method,headers:a.headers},i=new Request(`${a.headers["x-forwarded-proto"]||"http"}://${a.headers.host}${a.url}`,u);i.raw={requester:a,socket:n,head:h},await e(i)}),l.listen(s,r,()=>{(t.onListen||function({port:a,hostname:n}){console.error(`Serving at http://${n}:${a}`)})({port:s,hostname:r})}),l},setEnv:(e,t)=>{process.env[e]=t},sleep:function(e,t=0){return new Promise((s,r)=>{setTimeout(s,e+Math.floor(t*Math.random()))})},upgradeWebSocket:e=>{let t=new WebSocketService({noServer:!0}),s=new y(e);return t.handleUpgrade(e.raw.requester,e.raw.socket,e.raw.head,function(r){s.attach(r)}),{socket:s,response:new Response(null,{status:200})}},writeFile:async function(e,t,s={}){let r={flag:"w"};s.append&&(r.flag="a"),s.signal&&(r.signal=s.signal),s.mode&&(r.mode=s.mode),await fs.promises.writeFile(e,t,r)}};var m=async function(){WingBlade.serve(()=>new Response("Test me!"))};self.WingBlade=f;m(f.args);})();
