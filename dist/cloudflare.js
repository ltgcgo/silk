"use strict";(()=>{var l=class{#e={onclose:[],onerror:[],onmessage:[],onopen:[],close(){},readyState:0,isDummy:!0};#s="";#a=async function(e){let t=this,r=AbortSignal.timeout(5e3),i,n=function(){let s=new Error("Bad WebSocket handshake");t.#e?.onerror?.forEach(function(a){a[0](s)}),t.#e?.onclose?.forEach(function(a){a[0]()})};r.addEventListener("abort",function(){(!i||i?.readyState!=1)&&n()}),i=await fetch(e,{headers:{Upgrade:"websocket"}});let o=i.webSocket;o?(this.#e.onclose.forEach(function(s){o.addEventListener("close",...s)}),this.#e.onerror.forEach(function(s){o.addEventListener("error",...s)}),this.#e.onmessage.forEach(function(s){o.addEventListener("message",...s)}),this.#e.onopen.forEach(function(s){o.addEventListener("open",...s)}),o.addEventListener("error",function(){o.close()}),o.accept(),this.#e=o):n()};addEventListener(...e){this.#e.isDummy?this.#e[`on${e[0]}`].push(e.slice(1)):this.#e?.addEventListener(...e)}close(...e){this.#e.close(...e)}send(...e){this.#e?.send(...e)}get url(){return this.#s}get readyState(){return this.#e.readyState}constructor(e){let t=e;e.indexOf("ws")==0&&(t=e.replace("ws","http")),this.#s=t,this.#a(t)}};var h={args:[],os:"linux",variant:"Cloudflare",version:"v1.0.0",persist:!0,exit:(e=0)=>{throw new Error(`WingBlade attempted exitting with code ${e}.`)},getEnv:(e,t)=>self[e]||t,memUsed:()=>0,randomInt:e=>Math.floor(Math.random()*e),readFile:async function(e,t){throw new Error("File reads are not permitted on this platform.")},serve:(e,t={})=>{self.addEventListener("fetch",async function(r){let i=r.request,n=i.headers.get("cf-connecting-ip");r.respondWith(e(i))}),console.error("WingBlade serving at (Wrangler Dev Server)")},setEnv:(e,t)=>{self[e]=t},sleep:function(e,t=0){return new Promise((r,i)=>{setTimeout(r,e+Math.floor(t*Math.random()))})},upgradeWebSocket:e=>{let[t,r]=Object.values(new WebSocketPair);r.accept();let i=r.addEventListener;return Object.defineProperty(r,"addEventListener",{value:function(n,...o){n=="open"?o[0].call(r):i.call(r,n,...o)}}),{socket:r,response:new Response(null,{status:101,webSocket:t})}},writeFile:async function(e,t,r={}){throw new Error("File writes are not permitted on this platform.")}};var k="currentTarget,explicitOriginalTarget,originalTarget,srcElement,target".split(",");var u={account:"user",application:"app",content:"text",created_at:"atNew",edited_at:"atEdit",favourites_count:"sumFav",in_reply_to_account_id:"replyUser",in_reply_to_id:"replyPost",language:"lang",media_attachments:"media",mentions:"ats",reblog:"boost",reblogs_count:"sumBoost",replies_count:"sumReply",sensitive:"cwReal",spoiler_text:"cwText",visibility:"access",followers_count:"sumFan",following_count:"sumSub",display_name:"dispName",avatar_static:"avatarStatic",header_static:"headerStatic",statuses_count:"sumPost",last_status_at:"atLastPost",noindex:"noIndex",verified_at:"atVerify",shortcode:"code",static_url:"static",visible_in_picker:"inPicker",expires_at:"atExpire",votes_count:"sumVote",voters_count:"sumVoter",website:"site",preview_url:"preview",remote_url:"remote",preview_remote_url:"previewRemote",text_url:"text",description:"alt"},v={update:"postNew","status.update":"postEdit",delete:"postDel"},f=class extends EventTarget{#e=40;#s=80;#a=2592e5;#l="";#c="";#u;#n=[];#o={};#f=[];#p=[];#E=[];#t=[];#r={};USER_NORMAL=0;USER_NOEXEMPT=1;USER_EXCLUDED=2;#h(e,t){return(t.atNew||0)-(e.atNew||0)}#m(){}#v(){}#g(){}#i(e){for(let t in e)u[t]&&(e[u[t]]=e[t],delete e[t]);return e.atNew&&(e.atNew=new Date(e.atNew).getTime()),e.atEdit&&(e.atEdit=new Date(e.atEdit).getTime()),e.atVerify&&(e.atVerify=new Date(e.atVerify).getTime()),e.atExpire&&(e.atExpire=new Date(e.atExpire).getTime()),e.app&&this.#i(e.app),e.user&&this.#i(e.user),e.media?.forEach(t=>{this.#i(t)}),e.emojis?.forEach(t=>{this.#i(t)}),e.ats?.forEach(t=>{this.#i(t)}),e.user&&e.user.fields?.forEach(t=>{this.#i(t)}),e.poll&&(e.poll.options?.forEach(t=>{this.#i(t)}),this.#i(e.poll)),e}#d(e,t){return this.#i(e),e?.user?.username&&(e.handle=`@${e.user.username}@${t.domain}`),e.rid=`${e.id}@${t.domain}`,e}receiver(e,t){let r;switch(t.event){case"update":{let i=t.payload.constructor==String?JSON.parse(t.payload):t.payload;this.#d(i,e),this.#t.unshift(i),this.#r[i.rid]=i,console.error(`CREATE Post ${i.rid} success.`),r=i;break}case"status.update":{let i=JSON.parse(t.payload);if(this.#d(i,e),this.#r[i.rid]){let n=this.#t.indexOf(this.#r[i.rid]);n>-1?(this.#t[n]=i,this.#r[i.rid]=i,console.error(`MODIFY Post ${i.rid} success.`)):console.error(`MODIFY Post ${i.rid} not found in postStore.`)}else console.error(`MODIFY Post ${i.rid} not found in postRef.`);r=i;break}case"delete":{let i=`${t.payload}@${e.domain}`;if(this.#r[i]){let n=this.#t.indexOf(this.#r[i]);n>-1?(this.#t.splice(n,1),console.error(`DELETE Post ${i} success.`)):console.error(`DELETE Post ${i} not found in postStore.`)}else console.error(`DELETE Post ${i} not found in postRef.`);r=t.payload;break}default:console.error(`Unknown message type ${t.event}.`)}this.#t.sort(this.#h),this.#t.length>this.#s&&this.#t.splice(this.#s,this.#t.length-this.#s).forEach(i=>{delete this.#r[i.rid]}),this.dispatchEvent(new MessageEvent(v[t.event]||t.event,{data:r}))}getPosts(){return this.#t}startFor(e){e.ws=new l(`wss://${e.domain}/api/v1/streaming/`),e.ws.addEventListener("open",()=>{e.ws.send('{"type":"subscribe","stream":"public:local"}'),e.domain==this.#l&&e.ws.send(`{"type":"subscribe","stream":"user","access_token":"${this.#c}"}`)}),e.ws.addEventListener("message",t=>{let r=JSON.parse(t.data);this.receiver.call(this,e,r)}),e.ws.addEventListener("close",()=>{AbortSignal.timeout(3e3).onabort=()=>{this.startFor(e)}}),console.info(`Started for ${e.domain}.`)}launch(e){this.#n.forEach(async t=>{if(console.info(`Starting for ${t.domain}.`),this.startFor.call(this,t),!e){let r={headers:{}};t.auth&&(r.headers.Authorization=`Bearer ${t.auth}`),(await(await fetch(`https://${t.domain}/api/v1/timelines/public?local=1&limit=${this.#e}`)).json())?.forEach(i=>{this.receiver(t,{event:"update",payload:i})})}})}constructor({servers:e,serversCw:t,instance:r,accessToken:i,serversTk:n,streamOnly:o=!1}){super(),e?.forEach(s=>{let a={domain:s,ws:void 0,cw:!1};this.#o[s]=this.#n.length,this.#n.push(a)}),t?.forEach(s=>{let a={domain:s,ws:void 0,cw:!0};this.#o[s]=this.#n.length,this.#n.push(a)}),n?.forEach(s=>{this.#n[this.#o[s[0]]].auth=s[1]}),this.#l=r,this.#c=i,this.launch(o)}};var p=async function(e){switch(e[0]||"serve"){case"login":{let t=e[1];t||(console.error("Target instance not defined!"),WingBlade.exit(1)),console.error(`Trying to log into ${t}.`),console.error("Obtaining app token...");let r=new FormData;r.set("client_name","Lightingale Silk"),r.set("redirect_uris","http://127.0.0.1:19810/"),r.set("website","https://mlp.ltgc.cc/silk/");let i=await(await fetch(`https://${t}/api/v1/apps`,{method:"post",body:r})).json();console.error(`Registered Silk as app ${i.id}.`),console.info(`Client ID: ${i.client_id}`),console.info(`Client Secret: ${i.client_secret}`),WingBlade.serve(async()=>(WingBlade.sleep(1e3).then(()=>{console.error("Login success."),WingBlade.exit(0)}),new Response("OK")),{onListen:()=>{console.error(`Open https://${t}/oauth/authorize?response_type=code&client_id=${i.client_id}&redirect_uri=${encodeURIComponent("http://127.0.0.1:19810/")}`)},port:19810});break}case"serve":{let t=WingBlade.getEnv("LIST_SERVER")?.split(",")||[],r=WingBlade.getEnv("LIST_SERVER_CW")?.split(",")||[],i=WingBlade.getEnv("LIST_SERVER_TK")?.split(",")||[],n=WingBlade.getEnv("HOOK_SERVER"),o=WingBlade.getEnv("HOOK_AUTH"),s=WingBlade.getEnv("NO_BATCH_REQUEST")||WingBlade.variant=="Cloudflare";n||(console.error("Hook server not defined!"),WingBlade.exit(1)),o||(console.error("Hook server not logged in!"),WingBlade.exit(1)),i.forEach((c,E,m)=>{let d=c.indexOf("=");d>-1&&(m[E]=[c.slice(0,d),c.slice(d+1)])});let a={servers:t,serversCw:r,serversTk:i,instance:n,accessToken:o,streamOnly:s};console.info(a);let g=new f(a);WingBlade.serve(()=>new Response("Test me!"));break}default:console.error(`Unknown subcommand "${e.join(" ")}"`)}};self.WingBlade=h;p(h.args);})();
