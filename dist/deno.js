"use strict";(()=>{function p(){let t,e="pending",s=new Promise((r,n)=>{t={async resolve(o){await o,e="fulfilled",r(o)},reject(o){e="rejected",n(o)}}});return Object.defineProperty(s,"state",{get:()=>e}),Object.assign(s,t)}function b(t,e={}){let{signal:s,persistent:r}=e;return s?.aborted?Promise.reject(new DOMException("Delay was aborted.","AbortError")):new Promise((n,o)=>{let i=()=>{clearTimeout(h),o(new DOMException("Delay was aborted.","AbortError"))},h=setTimeout(()=>{s?.removeEventListener("abort",i),n()},t);if(s?.addEventListener("abort",i,{once:!0}),r===!1)try{Deno.unrefTimer(h)}catch(l){if(!(l instanceof ReferenceError))throw l;console.error("`persistent` option is only available in Deno")}})}var w=class{#i=0;#r=[];#l=[];#e=p();add(e){++this.#i,this.#s(e[Symbol.asyncIterator]())}async#s(e){try{let{value:s,done:r}=await e.next();r?--this.#i:this.#r.push({iterator:e,value:s})}catch(s){this.#l.push(s)}this.#e.resolve()}async*iterate(){for(;this.#i>0;){await this.#e;for(let e=0;e<this.#r.length;e++){let{iterator:s,value:r}=this.#r[e];yield r,this.#s(s)}if(this.#l.length){for(let e of this.#l)throw e;this.#l.length=0}this.#r.length=0,this.#e=p()}}[Symbol.asyncIterator](){return this.iterate()}},c="Server closed",D=5,S=1e3,u=class{#i;#r;#l;#e=!1;#s=new Set;#h=new AbortController;#n=new Set;#c;constructor(e){this.#i=e.port,this.#r=e.hostname,this.#l=e.handler,this.#c=e.onError??function(s){return console.error(s),new Response("Internal Server Error",{status:500})}}async serve(e){if(this.#e)throw new Deno.errors.Http(c);this.#o(e);try{return await this.#p(e)}finally{this.#d(e);try{e.close()}catch{}}}async listenAndServe(){if(this.#e)throw new Deno.errors.Http(c);let e=Deno.listen({port:this.#i??80,hostname:this.#r??"0.0.0.0",transport:"tcp"});return await this.serve(e)}async listenAndServeTls(e,s){if(this.#e)throw new Deno.errors.Http(c);let r=Deno.listenTls({port:this.#i??443,hostname:this.#r??"0.0.0.0",certFile:e,keyFile:s,transport:"tcp"});return await this.serve(r)}close(){if(this.#e)throw new Deno.errors.Http(c);this.#e=!0;for(let e of this.#s)try{e.close()}catch{}this.#s.clear(),this.#h.abort();for(let e of this.#n)this.#t(e);this.#n.clear()}get closed(){return this.#e}get addrs(){return Array.from(this.#s).map(e=>e.addr)}async#u(e,s){let r;try{if(r=await this.#l(e.request,s),r.bodyUsed&&r.body!==null)throw new TypeError("Response body already consumed.")}catch(n){r=await this.#c(n)}try{await e.respondWith(r)}catch{}}async#f(e,s){for(;!this.#e;){let r;try{r=await e.nextRequest()}catch{break}if(r===null)break;this.#u(r,s)}this.#t(e)}async#p(e){let s;for(;!this.#e;){let r;try{r=await e.accept()}catch(i){if(i instanceof Deno.errors.BadResource||i instanceof Deno.errors.InvalidData||i instanceof Deno.errors.UnexpectedEof||i instanceof Deno.errors.ConnectionReset||i instanceof Deno.errors.NotConnected){s?s*=2:s=D,s>=1e3&&(s=S);try{await b(s,{signal:this.#h.signal})}catch(a){if(!(a instanceof DOMException&&a.name==="AbortError"))throw a}continue}throw i}s=void 0;let n;try{n=Deno.serveHttp(r)}catch{continue}this.#w(n);let o={localAddr:r.localAddr,remoteAddr:r.remoteAddr};this.#f(n,o)}}#t(e){this.#m(e);try{e.close()}catch{}}#o(e){this.#s.add(e)}#d(e){this.#s.delete(e)}#w(e){this.#n.add(e)}#m(e){this.#n.delete(e)}};function T(t){return t==="0.0.0.0"?"localhost":t}async function m(t,e={}){let s=e.port??8e3,r=e.hostname??"0.0.0.0",n=new u({port:s,hostname:r,handler:t,onError:e.onError});e?.signal?.addEventListener("abort",()=>n.close(),{once:!0});let o=n.listenAndServe();return s=n.addrs[0].port,"onListen"in e?e.onListen?.({port:s,hostname:r}):console.log(`Listening on http://${T(r)}:${s}/`),await o}var f={args:Deno.args,os:Deno.build.os,variant:"Deno",version:Deno.version.deno,persist:!0,exit:(t=0)=>{Deno.exit(t)},getEnv:(t,e)=>Deno.env.get(t)||e,memUsed:()=>Deno.memoryUsage(),randomInt:t=>Math.floor(Math.random()*t),readFile:async function(t,e){return await Deno.readFile(t,e)},serve:(t,e={})=>(e?.onListen||(e.onListen=function({port:s,hostname:r}){console.error(`WingBlade serving at http://${r}:${s}`)}),e?.hostname||(e.hostname="127.0.0.1"),e?.port||(e.port=8e3),m(t,e)),setEnv:(t,e)=>Deno.env.set(t,e),sleep:function(t,e=0){return new Promise((s,r)=>{AbortSignal.timeout(t+Math.floor(e*Math.random())).addEventListener("abort",()=>{s()})})},upgradeWebSocket(t,e){return Deno.upgradeWebSocket(t,e)},writeFile:async function(t,e,s){await Deno.writeFile(t,e,s)}};var $="currentTarget,explicitOriginalTarget,originalTarget,srcElement,target".split(",");var E={account:"user",application:"app",content:"text",created_at:"atNew",edited_at:"atEdit",favourites_count:"sumFav",in_reply_to_account_id:"replyUser",in_reply_to_id:"replyPost",language:"lang",media_attachments:"media",mentions:"ats",reblog:"boost",reblogs_count:"sumBoost",replies_count:"sumReply",sensitive:"cwReal",spoiler_text:"cwText",visibility:"access",followers_count:"sumFan",following_count:"sumSub",display_name:"dispName",avatar_static:"avatarStatic",header_static:"headerStatic",statuses_count:"sumPost",last_status_at:"atLastPost",noindex:"noIndex",verified_at:"atVerify",shortcode:"code",static_url:"static",visible_in_picker:"inPicker",expires_at:"atExpire",votes_count:"sumVote",voters_count:"sumVoter",website:"site",preview_url:"preview",remote_url:"remote",preview_remote_url:"previewRemote",text_url:"text",description:"alt"},k={update:"postNew","status.update":"postEdit",delete:"postDel"},v=class extends EventTarget{#i=40;#r=80;#l=2592e5;#e="";#s="";#h;#n=[];#c={};#u=[];#f=[];#p=[];#t=[];#o={};USER_NORMAL=0;USER_NOEXEMPT=1;USER_EXCLUDED=2;#d(t,e){return(e.atNew||0)-(t.atNew||0)}#w(){}#m(){}#v(){}#a(t){for(let e in t)E[e]&&(t[E[e]]=t[e],delete t[e]);return t.atNew&&(t.atNew=new Date(t.atNew).getTime()),t.atEdit&&(t.atEdit=new Date(t.atEdit).getTime()),t.atVerify&&(t.atVerify=new Date(t.atVerify).getTime()),t.atExpire&&(t.atExpire=new Date(t.atExpire).getTime()),t.app&&this.#a(t.app),t.user&&this.#a(t.user),t.media?.forEach(e=>{this.#a(e)}),t.emojis?.forEach(e=>{this.#a(e)}),t.ats?.forEach(e=>{this.#a(e)}),t.user&&t.user.fields?.forEach(e=>{this.#a(e)}),t.poll&&(t.poll.options?.forEach(e=>{this.#a(e)}),this.#a(t.poll)),t}#E(t,e){return this.#a(t),t?.user?.username&&(t.handle=`@${t.user.username}@${e.domain}`),t.rid=`${t.id}@${e.domain}`,t}receiver(t,e){let s;switch(e.event){case"update":{let r=e.payload.constructor==String?JSON.parse(e.payload):e.payload;this.#E(r,t),this.#t.unshift(r),this.#o[r.rid]=r,console.error(`CREATE Post ${r.rid} success.`),s=r;break}case"status.update":{let r=JSON.parse(e.payload);if(this.#E(r,t),this.#o[r.rid]){let n=this.#t.indexOf(this.#o[r.rid]);n>-1?(this.#t[n]=r,this.#o[r.rid]=r,console.error(`MODIFY Post ${r.rid} success.`)):console.error(`MODIFY Post ${r.rid} not found in postStore.`)}else console.error(`MODIFY Post ${r.rid} not found in postRef.`);s=r;break}case"delete":{let r=`${e.payload}@${t.domain}`;if(this.#o[r]){let n=this.#t.indexOf(this.#o[r]);n>-1?(this.#t.splice(n,1),console.error(`DELETE Post ${r} success.`)):console.error(`DELETE Post ${r} not found in postStore.`)}else console.error(`DELETE Post ${r} not found in postRef.`);s=e.payload;break}default:console.error(`Unknown message type ${e.event}.`)}this.#t.sort(this.#d),this.#t.length>this.#r&&this.#t.splice(this.#r,this.#t.length-this.#r).forEach(r=>{delete this.#o[r.rid]}),this.dispatchEvent(new MessageEvent(k[e.event]||e.event,{data:s}))}getPosts(){return this.#t}startFor(t){t.ws=new WebSocket(`wss://${t.domain}/api/v1/streaming/`),t.ws.addEventListener("open",()=>{t.ws.send('{"type":"subscribe","stream":"public:local"}'),t.domain==this.#e&&t.ws.send(`{"type":"subscribe","stream":"user","access_token":"${this.#s}"}`)}),t.ws.addEventListener("message",e=>{let s=JSON.parse(e.data);this.receiver.call(this,t,s)}),t.ws.addEventListener("close",()=>{AbortSignal.timeout(3e3).onabort=()=>{this.startFor(t)}}),console.info(`Started for ${t.domain}.`)}launch(t){this.#n.forEach(async e=>{if(console.info(`Starting for ${e.domain}.`),this.startFor.call(this,e),!t){let s={headers:{}};e.auth&&(s.headers.Authorization=`Bearer ${e.auth}`),(await(await fetch(`https://${e.domain}/api/v1/timelines/public?local=1&limit=${this.#i}`)).json())?.forEach(r=>{this.receiver(e,{event:"update",payload:r})})}})}constructor({servers:t,serversCw:e,instance:s,accessToken:r,serversTk:n,streamOnly:o=!1}){super(),t?.forEach(i=>{let a={domain:i,ws:void 0,cw:!1};this.#c[i]=this.#n.length,this.#n.push(a)}),e?.forEach(i=>{let a={domain:i,ws:void 0,cw:!0};this.#c[i]=this.#n.length,this.#n.push(a)}),n?.forEach(i=>{this.#n[this.#c[i[0]]].auth=i[1]}),this.#e=s,this.#s=r,this.launch(o)}};var g=async function(t){switch(t[0]||"serve"){case"login":{let e=t[1];e||(console.error("Target instance not defined!"),WingBlade.exit(1)),console.error(`Trying to log into ${e}.`),console.error("Obtaining app token...");let s=new FormData;s.set("client_name","Lightingale Silk"),s.set("redirect_uris","http://127.0.0.1:19810/"),s.set("website","https://mlp.ltgc.cc/silk/");let r=await(await fetch(`https://${e}/api/v1/apps`,{method:"post",body:s})).json();console.error(`Registered Silk as app ${r.id}.`),console.info(`Client ID: ${r.client_id}`),console.info(`Client Secret: ${r.client_secret}`),WingBlade.serve(async()=>(WingBlade.sleep(1e3).then(()=>{console.error("Login success."),WingBlade.exit(0)}),new Response("OK")),{onListen:()=>{console.error(`Open https://${e}/oauth/authorize?response_type=code&client_id=${r.client_id}&redirect_uri=${encodeURIComponent("http://127.0.0.1:19810/")}`)},port:19810});break}case"serve":{let e=WingBlade.getEnv("LIST_SERVER")?.split(",")||[],s=WingBlade.getEnv("LIST_SERVER_CW")?.split(",")||[],r=WingBlade.getEnv("LIST_SERVER_TK")?.split(",")||[],n=WingBlade.getEnv("HOOK_SERVER"),o=WingBlade.getEnv("HOOK_AUTH"),i=WingBlade.getEnv("NO_BATCH_REQUEST")||WingBlade.variant=="Cloudflare";n||(console.error("Hook server not defined!"),WingBlade.exit(1)),o||(console.error("Hook server not logged in!"),WingBlade.exit(1)),r.forEach((l,y,_)=>{let d=l.indexOf("=");d>-1&&(_[y]=[l.slice(0,d),l.slice(d+1)])});let a={servers:e,serversCw:s,serversTk:r,instance:n,accessToken:o,streamOnly:i};console.info(a);let h=new v(a);WingBlade.serve(()=>new Response("Test me!"));break}default:console.error(`Unknown subcommand "${t.join(" ")}"`)}};self.WingBlade=f;g(f.args);})();
